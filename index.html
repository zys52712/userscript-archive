<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MFC Doomscroll</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #2a2a2a;
            color: #DDDDDD;
            margin: 0;
        }
        header {
            background: #222222;
            padding: 25px 40px;
            box-shadow: 0 2px 2px rgba(0, 0, 0, .1);

            h1 {
                margin: 0;
            }
        }
        .main-container {
            margin: 30px auto !important;
            padding: 8px;
            width: 1280px;
            margin: auto;
            background: #222222;
            display: grid;
            gap: 20px;

            .input-container {
                background-color: #272727;
                padding: 15px;
                margin: 8px;

                display: flex;
                flex-direction: row;
                flex-wrap: nowrap;
                align-items: center;
                border-radius: 50px;
                gap: 10px;

                input {
                    background: none;
                    border: none;
                    color: white;
                    color-scheme: dark;
                    font-size: 18px;

                    &:focus-visible {
                        outline: none;
                    }
                }
            }
            .image-container {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                justify-content: center;

                img {
                    height: 196px;
                    object-fit: contain;
                    max-width: 512px;
                }
            }

            button {
                font-size: 16px;
                cursor: pointer;

                margin: 0 auto 25px;
                padding: 4px 24px;
                border: 0;
                border-radius: 20px;
                line-height: 32px;
                cursor: pointer;
                transition: opacity .2s ease;
                font-weight: 700;
                background-color: #555;
                color: #eee;

                &.load-custom {
                    margin: auto 0 auto auto;
                }
            }

            span {
                font-size: 16px;
                line-height: 16px;

                &:first-child {
                    margin-left: 6px;
                }
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>MFC Doomscroll</h1>
    </header>
    <div class="main-container">
        <div class="input-container">
            <span>Starting ID:</span>
            <input id="startingId" type="number" oninput="changeStartID(event)" placeholder="initial ID" value="4177191"/>
            <span>Starting Date:</span>
            <input id="startingDate" type="date" oninput="changeStartDate(event)" placeholder="initial date" value="2024-10-16"/>
            <button class="load-custom" onclick="loadCustom()">Load</button>
        </div>
        <div class="image-container" id="imageContainer"></div>
        <button id="loadMoreBtn" onclick="nextPage()">Load 100 Images</button>
    </div>
    <script>
        let imageId = 4177191;  // Starting point
        let globalCurrent = new Date(2024, 9, 16);  // Start date: 2024-10-16 (months are zero-indexed)
        let globalPrev = new Date(2024, 9, 15);

        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);

        const id = params.get('id');
        const date = params.get('date');

        if (id && date) {
            imageId = id;
            let selectedDate = date.split('-');
            globalCurrent = new Date(selectedDate[0], selectedDate[1] - 1, selectedDate[2]);
            globalPrev = new Date(globalCurrent);
            globalPrev.setDate(globalPrev.getDate() - 1);

            document.getElementById('startingId').value = id;
            document.getElementById('startingDate').value = date;

            console.log(globalCurrent.toDateString())
            console.log(globalPrev.toDateString())
        }

        const baseUrl = "https://static.myfigurecollection.net/upload/pictures/";
        const imageContainer = document.getElementById('imageContainer');
        const loadMoreBtn = document.getElementById('loadMoreBtn');

        async function fetchImagePage(id) {
            const mainImageUrl = `https://myfigurecollection.net/picture/${id}`;
            let response = await fetch(mainImageUrl);
            return !!response.ok;
        }

        function getUrl(date, id, extension) {
            return `${baseUrl}${date}/thumbnails/${imageId}.${extension}`;
        }

        function changeStartID(event) {
            imageId = event.target.value;
            console.log(imageId)
        }

        // Load another 100 images on button click
        loadMoreBtn.addEventListener('click', function() {
            //loadImages(100);
        });

        function loadCustom() {
            const nextPageUrl = `/?id=${imageId}&date=${globalCurrent.toISOString().split('T')[0]}`;
            window.location.href = nextPageUrl;
        }

        function nextPage() {
            const lastImage = document.querySelector('.imageContainer:last-child');
            const nextPageUrl = `/?id=${lastImage.dataset.id}&date=${lastImage.dataset.date}`;
            window.location.href = nextPageUrl;
        }

        function changeStartDate(event) {
            let selectedDate = event.target.value.split('-');
            globalCurrent = new Date(selectedDate[0], selectedDate[1] - 1, selectedDate[2]);
            globalPrev = new Date(globalCurrent);
            globalPrev.setDate(globalPrev.getDate() - 1);
            console.log(globalCurrent.toDateString())
            console.log(globalPrev.toDateString())
        }

        function loadImages(count = 100) {
            let successCount = 0;
            const maxImages = count;

            while (successCount < maxImages) {
                let currentDate = new Date(globalCurrent);
                let prevDate = new Date(globalPrev);

                console.log(currentDate.toDateString())
                console.log(prevDate.toDateString())
                const dateString = `${currentDate.getFullYear()}/${(currentDate.getMonth() + 1).toString().padStart(2, '0')}/${currentDate.getDate().toString().padStart(2, '0')}`;
                const prevDateString = `${prevDate.getFullYear()}/${(prevDate.getMonth() + 1).toString().padStart(2, '0')}/${prevDate.getDate().toString().padStart(2, '0')}`;
                const jpegUrl = `${baseUrl}${dateString}/thumbnails/${imageId}.jpeg`;
                const pngUrl = `${baseUrl}${dateString}/thumbnails/${imageId}.png`;
                const gifUrl = `${baseUrl}${dateString}/thumbnails/${imageId}.gif`;
                const prevJpegUrl = `${baseUrl}${prevDateString}/thumbnails/${imageId}.jpeg`;
                const prevPngUrl = `${baseUrl}${prevDateString}/thumbnails/${imageId}.png`;
                const prevGifUrl = `${baseUrl}${prevDateString}/thumbnails/${imageId}.gif`;
                const figureUrl = `https://myfigurecollection.net/picture/${imageId}`;

                // Create an image element
                const img = new Image();
                img.src = jpegUrl;
                img.dataset.id = imageId;

                img.onerror = function () {
                    img.src = pngUrl;

                    img.onerror = function () {
                        // If JPEG fails, try GIF
                        img.src = gifUrl;

                        img.onerror = function () {
                            img.src = prevJpegUrl;

                            img.onerror = function () {
                                img.src = prevPngUrl;

                                img.onerror = function () {
                                    img.src = prevGifUrl;

                                    img.onerror = function () {
                                        //private image
                                        imageId--;
                                        successCount++;
                                    };

                                    img.onload = function () {
                                        currentDate.setDate(currentDate.getDate() - 1);
                                        prevDate.setDate(prevDate.getDate() - 1);
                                        appendImage();
                                    };
                                };

                                img.onload = function () {
                                    currentDate.setDate(currentDate.getDate() - 1);
                                    prevDate.setDate(prevDate.getDate() - 1);
                                    appendImage();
                                };
                            }

                            img.onload = function () {
                                currentDate.setDate(currentDate.getDate() - 1);
                                prevDate.setDate(prevDate.getDate() - 1);
                                appendImage();
                            };
                        };
                        img.onload = function () {
                            appendImage();
                        }
                    }
                    img.onload = function () {
                        appendImage();
                    }
                };

                img.onload = function () {
                    appendImage();
                }

                function apependImage() {
                    img.dataset.id = imageId;
                    const anchor = document.createElement('a');
                    anchor.href = figureUrl;
                    anchor.target = "_blank"; // Open link in a new tab
                    anchor.appendChild(img);

                    // Append the anchor (with image) to the container
                    imageContainer.appendChild(anchor);
                    console.log(`Loaded image: ${img.src}`);
                    successCount++;
                }

                function appendImage() {
                    globalCurrent.setDate(currentDate.getDate());
                    globalPrev.setDate(prevDate.getDate());
                    const anchor = document.createElement('a');
                    anchor.classList.add('imageContainer');
                    anchor.href = figureUrl;
                    anchor.target = "_blank"; // Open link in a new tab
                    anchor.appendChild(img);

                    anchor.dataset.date = currentDate.toISOString().split('T')[0];
                    anchor.dataset.id = img.dataset.id;
                    const num = parseInt(img.dataset.id);

                    // Find the largest dataset ID that is smaller than the current imageId
                    let largestSmallerImage = null;
                    let largestId = -1; // Start with an invalid ID

                    // Get all images currently in the container
                    const existingImages = document.querySelectorAll('a.imageContainer');

                    existingImages.forEach(existingAnchor => {
                        const existingImg = existingAnchor.querySelector('img'); // Assuming each anchor contains an img
                        const existingId = parseInt(existingImg.dataset.id); // Assuming dataset id is stored here
                        console.log(existingId)

                        if (existingId < num && existingId > largestId) {
                            largestId = existingId;
                            largestSmallerImage = existingAnchor; // Keep a reference to the anchor
                        }
                    });

                    // Append the new image before the found image or at the end if none is found
                    if (largestSmallerImage) {
                        // Insert the new anchor before the found anchor
                        imageContainer.insertBefore(anchor, largestSmallerImage);
                    } else {
                        // If no smaller image was found, append to the end
                        imageContainer.appendChild(anchor);
                    }


                    console.log(globalCurrent.toDateString())
                    console.log(globalPrev.toDateString())
                    console.log(`Loaded image: ${img.src}`);
                }

				successCount++;  // Increment regardless of success or failure

                imageId--;  // Decrement the image number

				// If no image found for this day, move to the previous date
            }

            console.log(`Finished loading ${count} images.`);
        }

        // Load the first 100 images
        loadImages();
    </script>
</body>
</html>
